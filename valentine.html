<!doctype html>
<html>
	<head>
		<title>Happy Valentine's Day!</title>
		<meta charset="utf-8" />
    <style>
      html, body { margin: 0; padding: 0; border: 0; }
      #c { display: block; } /* kill scrollbars from hell */
      canvas { cursor: default;}
      #toolbar { position: absolute; top: 0; left: 0; width: 100px; height: 100%; background-color: rgba(20,20,20,.2); text-align: center; }
      #toolbar button { margin: 40px auto; display: block }
      img #preview { display:none; }
    </style>
    <script type="text/javascript" src="dat.gui.js"></script>
	</head>
	<body>
		<canvas id="c"></canvas>
		<script>
			var a = document.getElementsByTagName('canvas')[0];
			var b = document.body;
      var d = function(e){ return function(){ e.parentNode.removeChild(e); }; }(a);
      // unprefix some popular vendor prefixed things (but stick to their original name)
      var AudioContext =
        window.AudioContext ||
        window.webkitAudioContext;
      var requestAnimationFrame =
        window.requestAnimationFrame ||
        window.mozRequestAnimationFrame ||
         window.webkitRequestAnimationFrame ||
       window.msRequestAnimationFrame ||
        function(f){ setInterval(f, 1000/30); };
      // stretch canvas to screen size (once, wont onresize!)
      a.style.width = (a.width = innerWidth) + 'px';
      a.style.height = (a.height = innerHeight) + 'px';

      var c = a.getContext('2d');
      var bg;
      var mouseClicked = false;

      // History tracking
      var strokeStack = [];
      var curStroke = [];
		</script>
		<script>
      var Background = function() {
        this.color      = [255,71,125];
        this.threshold  = 3;
        this.pixelSize  = 20;
        this.blur       = 5;
      };

      var Heart = {
        color: "#40121F"
      }

      // renders the drawing, if any
      var renderDrawing = function() {
        for(var i=0;i<strokeStack.length;i++) {
          var cur = strokeStack[i];
          for(var j=0;j<cur.length;j++) {
            fillPixel(cur[j][0],cur[j][1]);
          }
        }
      }

      var drawBackground = function(bg) {      
        for(var i=0;i<a.width/bg.pixelSize;i++) {
          for(var j=0;j<a.height/bg.pixelSize;j++) {
            var color = getRandomColor();
            c.shadowBlur = bg.blur; c.shadowColor = color;
            c.fillStyle = color;
            c.fillRect(i*bg.pixelSize,j*bg.pixelSize,bg.pixelSize,bg.pixelSize);
          }
        }

        renderDrawing();
      }

      var listenHeart = function(e) {
        if(!mouseClicked) return;
        var pixX = Math.floor(e.x/bg.pixelSize);
        var pixY = Math.floor(e.y/bg.pixelSize);
        curStroke.push([pixX,pixY]);
        fillPixel(pixX,pixY);
      }
      var fillPixel = function(x,y,color) {
        var pixColor = color || Heart.color;
        c.shadowBlur = bg.blur; c.shadowColor = pixColor;
        c.fillStyle = pixColor;
        c.fillRect(x*bg.pixelSize,y*bg.pixelSize,bg.pixelSize,bg.pixelSize);
      }

      var getRandomColor = function() {
        return "rgb(" + g(bg.color[0]) + "," + g(bg.color[1]) + "," + g(bg.color[2]) + ")";;
      }

      var saveStroke = function(e) {
        mouseClicked = false;
        if(curStroke.length > 0) {
          strokeStack.push(curStroke);
        }
        curStroke = [];
      }

      var undo = function() {
        var undoStroke = strokeStack.pop();
        for(var j=0;j<undoStroke.length;j++) {
          fillPixel(undoStroke[j][0],undoStroke[j][1],getRandomColor());
        }
      }

      function g(baseColor) {
        return Math.max(0,Math.min(255,Math.round(baseColor) + gi(-bg.threshold,bg.threshold)));
      }
      function gi(min, max) {
        return Math.floor(Math.random() * (max - min + 1) + min);
      }

      window.onload = function() {
        bg = new Background();
        var gui = new dat.GUI();
        gui.close();

        var cc = gui.addColor(bg,'color').listen();
        var tc = gui.add(bg,'threshold',0,255).step(1).listen();
        var pc = gui.add(bg,'pixelSize',7,600).step(1).listen();
        var bc = gui.add(bg,'blur',0,600).step(1).listen();

        cc.onChange(function() { drawBackground(bg) });
        tc.onChange(function() { drawBackground(bg) });
        pc.onChange(function() { drawBackground(bg) });
        bc.onChange(function() { drawBackground(bg) });

        drawBackground(bg);
        a.onmousedown = function() { mouseClicked = true; }
        a.onmouseup   = saveStroke;
        a.onmousemove = listenHeart;
      };      
		</script>
    <div id="toolbar">
      <button id="save">save</button>
      <button id="undo" onclick="undo()">undo</button>
      <button id="share" >share</button>
    </div>
	</body>
</html>
